name: ðŸš€ Deploy CAMER GEO DATA

on:
    push:
        branches: [ "main" ]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.8.0
              with:
                ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Create .env.production locally
              run: |
                echo DB_HOST=${{ vars.DB_HOST }} >> .env.production
                echo DB_USER=${{ secrets.DB_USER }} >> .env.production
                echo DB_NAME=${{ secrets.DB_NAME }} >> .env.production
                echo DB_PASSWORD=${{ secrets.DB_PASSWORD }} >> .env.production
                echo DB_PORT=${{ vars.DB_PORT }} >> .env.production
                echo DEFAULT_DB_NAME=${{ vars.DEFAULT_DB_NAME }} >> .env.production
                echo PORT=${{ vars.PORT }} >> .env.production
                echo NODE_ENV=${{ vars.NODE_ENV }} >> .env.production
        
            - name: Create database.env locally
              run: |
                echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> database.env
                echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> database.env
                echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> database.env

            - name: Ensure target directory exists on VPS
              run: |
                ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
                    mkdir -p ${{ secrets.VPS_PATH }}
                "

            - name: Copy env files to VPS
              run: |
                scp -o StrictHostKeyChecking=no .env.production ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH }}/.env.production

            - name: Copy project to VPS
              run: |
                rsync -avz --delete \
                    --exclude '.git' \
                    --exclude 'node_modules' \
                    --exclude '.env*' \
                    -e "ssh -o StrictHostKeyChecking=no" \
                    ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH }}/

            - name: Deploy with Docker Compose
              run: |
                ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
                    cd ${{ secrets.VPS_PATH }} &&
                    docker compose down &&
                    docker compose up -d --build
                "
